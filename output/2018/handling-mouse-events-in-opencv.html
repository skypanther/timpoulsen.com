
<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="../theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="../theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="../theme/css/main.css">
  <link rel="stylesheet" type="text/css" href="../theme/font-awesome/css/font-awesome.min.css">

    <link href="http://www.timpoulsen.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Tim Poulsen Atom">


  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/images/favicons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/images/favicons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicons/favicon-16x16.png">
  <link rel="manifest" href="/images/favicons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/images/favicons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow" />

    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#143742">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#143742">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<meta name="author" content="Tim Poulsen" />
<meta name="description" content="For a project I'm working on, I need to select a region of interest in a video frame and extract info about that region. Fortunately, that's a pretty simple task to do in OpenCV. In this article, I'll show you how to detect and react to mouse actions, such as …" />
<meta name="keywords" content="opencv">
<meta property="og:site_name" content="Tim Poulsen"/>
<meta property="og:title" content="Handling mouse events in OpenCV"/>
<meta property="og:description" content="For a project I'm working on, I need to select a region of interest in a video frame and extract info about that region. Fortunately, that's a pretty simple task to do in OpenCV. In this article, I'll show you how to detect and react to mouse actions, such as …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="../2018/handling-mouse-events-in-opencv.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2018-05-21 00:00:00-04:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="../author/tim-poulsen.html">
<meta property="article:section" content="OpenCV"/>
<meta property="article:tag" content="opencv"/>
<meta property="og:image" content="/images/tim_poulsen.jpg">

  <title>Tim Poulsen &ndash; Handling mouse events in OpenCV</title>


    <link href="/theme/css/main.css" rel="stylesheet">

</head>
<body>
  <aside class="leftbar" style="background-color: #030E36;">
    <div class="leftbar" style="background-color: #030E36;">
      <a href="..">
        <img src="/images/tim_poulsen.jpg" alt="Tim Poulsen" title="Tim Poulsen">
      </a>
      <h1><a href="..">Tim Poulsen</a></h1>

<p class="subtitle">Explorations of software and hardware</p>
      <ul class="social">
        <li><a class="sc-twitter" href="https://twitter.com/skypanther" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-github" href="https://github.com/skypanther" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-linkedin" href="https://www.linkedin.com/in/timpoulsen" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-rss" href="feeds/all.atom.xml" target="_blank"><i class="fa fa-rss"></i></a></li>
      </ul>

      <nav>
        <ul class="list">
          <li><a href="../pages/about.html#about">About</a></li>

          <li><a href="/categories.html" target="_blank">Topics</a></li>
          <li><a href="http://skypanther.com" target="_blank">Skypanther Studios</a></li>
        </ul>
      </nav>

      <p class="subhead">Tags:</p>
      <ul class="tagcloud">
          <li class="tag-1">
              <a href="../tag/python.html">
              python
              </a>
          </li>
          <li class="tag-1">
              <a href="../tag/opencv.html">
              opencv
              </a>
          </li>
          <li class="tag-3">
              <a href="../tag/making.html">
              making
              </a>
          </li>
          <li class="tag-4">
              <a href="../tag/raspberrypi.html">
              raspberrypi
              </a>
          </li>
          <li class="tag-4">
              <a href="../tag/raspberry-pi.html">
              raspberry pi
              </a>
          </li>
          <li class="tag-4">
              <a href="../tag/anaconda.html">
              anaconda
              </a>
          </li>
      </ul>

    </div>


  </aside>
  <main>

    <nav>
      <a href="..">    Home
</a>

      <a href="/categories.html">Topics</a>
      <a href="/pages/about.html">About</a>
      <a href="/tags.html">Tags</a>

      <a href="http://www.timpoulsen.com/feeds/all.atom.xml">    Atom
</a>

    </nav>

<article class="single">
  <header>
    <h1 id="handling-mouse-events-in-opencv">Handling mouse events in OpenCV</h1>
    <p>
          Posted on Mon 21 May 2018 in <a href="../category/opencv.html">OpenCV</a>


    </p>
  </header>


  <div>
    <p>For a project I'm working on, I need to select a region of interest in a video frame and extract info about that region. Fortunately, that's a pretty simple task to do in OpenCV. In this article, I'll show you how to detect and react to mouse actions, such as clicking and moving. Then, as an example of what to do with that sort of functionality, we'll see how to crop an image to the dimensions selected.</p>
<p>You'll need Python and OpenCV installed. I'm using Python 3.6 (Anaconda) and OpenCV 3.4 myself. Open your favorite text editor and create a file named <strong>crop_image.py</strong> and enter the following code:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">cv2</span>

<span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">drawing</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>

<span class="k">def</span> <span class="nf">get_image</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>

<span class="k">def</span> <span class="nf">click_and_crop</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</td></tr></table><p>That gives us the shell of the file we'll fill in throughout the rest of this article. We'll need the argparse and cv2 (OpenCV) libraries, as well as a couple of global variables. We'll have a couple of functions plus <tt class="docutils literal">main()</tt> and the code to call <tt class="docutils literal">main()</tt> when we run the script.</p>
<p>Let's fill in the rest of <tt class="docutils literal">main()</tt>:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># construct the argument parser and parse the arguments</span>
    <span class="n">ap</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">ap</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="s2">&quot;--image&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to the image&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">ap</span><span class="o">.</span><span class="n">parse_args</span><span class="p">())</span>
    <span class="n">image_source</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="c1"># now get our image from either the file or built-in webcam</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">get_image</span><span class="p">(</span><span class="n">image_source</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># show the captured image in a window</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s1">&#39;CapturedImage&#39;</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">WINDOW_NORMAL</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;CapturedImage&#39;</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
        <span class="c1"># specify the callback function to be called when the user</span>
        <span class="c1"># clicks/drags in the &#39;CapturedImage&#39; window</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">setMouseCallback</span><span class="p">(</span><span class="s1">&#39;CapturedImage&#39;</span><span class="p">,</span> <span class="n">click_and_crop</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># wait for Esc or q key and then exit</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">27</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Image cropped at coordinates: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">coords</span><span class="p">))</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
                <span class="k">break</span>
</pre></div>
</td></tr></table><p>That's a good chunk of code. Let's walk through what it's doing. Using argparse, the script will look for and parse command-line arguments. This script will accept a single argument (either <tt class="docutils literal"><span class="pre">-i</span></tt> or <tt class="docutils literal"><span class="pre">--image</span></tt>) to specify an image file to load. We'll store the value in an <tt class="docutils literal">image_source</tt> variable on line 12. If no image is specified, we'll store <tt class="docutils literal">0</tt> in the variable -- that will tell the script to use the default webcam on the system as the image source.</p>
<p>One line 14, we call our <tt class="docutils literal">get_image()</tt> function (which we've yet to write) to load our image. If we successfully load the image, the statements in the <tt class="docutils literal">if</tt> block will run. line 17 createa a named <tt class="docutils literal">cv2.imshow</tt> window and the next line shows the image in that window.</p>
<p>Line 21 is perhaps the key line here. With <tt class="docutils literal">setMouseCallback()</tt> we specify which window to listen for mouse events on ('CapturedImage'), what function to call each time there's a mouse event (a click, drag, move, etc.), as well as an optional third parameter. The <tt class="docutils literal">cv2.setMouseCallback()</tt> function lets us pass whatever value we want in that third parameter. In the docs and other examples, you'll typically see it named generically as <tt class="docutils literal">param</tt> for this reason. We'll use it to pass the image to that function.</p>
<p>Finally, we want the image window to remain open while the rest of the script operates. So, we use a while loop. In each iteration of the loop, we use the <tt class="docutils literal">cv.waitKey()</tt> function to listen for a key press. If the key pressed is the escape key (value 27) or the letter q (the script would actually receive the ordinal value of the character 'q'), then we destroy all the cv2 windows and break out of the loop, ending the script.</p>
<p>There's the main logic of our script -- get an image, show it, then watch for mouse events and call a function when they happen. We've got a couple of other functions to write. Let's tackle <tt class="docutils literal">get_image()</tt> first.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_image</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="c1"># open the camera, grab a frame, and release the camera</span>
    <span class="n">cam</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">image_captured</span><span class="p">,</span> <span class="n">image</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">cam</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">image_captured</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">image</span>
    <span class="k">return</span> <span class="bp">None</span>
</pre></div>
</td></tr></table><p>This function is pretty straightforward. We'll use <tt class="docutils literal">cv2.VideoCapture()</tt> to open whatever source it's passed (which will be either a filename or <tt class="docutils literal">0</tt> for the webcam). It will read a single frame, then return the captured image.</p>
<p>The bigger function is <tt class="docutils literal">click_and_crop()</tt> which is our event handler. Let's see this one in stages.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>39
40
41
42
43
44
45
46</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">click_and_crop</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Callback function, called by OpenCV when the user interacts</span>
<span class="sd">    with the window using the mouse. This function will be called</span>
<span class="sd">    repeatedly as the user interacts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get access to the two global variables we&#39;ll need</span>
    <span class="k">global</span> <span class="n">coords</span><span class="p">,</span> <span class="n">drawing</span>
</pre></div>
</td></tr></table><p>Here we see the function signature. When called, the function will be passed five arguments. The first is the event, such as the left button being pressed down (<tt class="docutils literal">cv2.EVENT_LBUTTONDOWN</tt>). Next comes the x/y coordinates of the event. I could not find documentation on the <tt class="docutils literal">flag</tt> parameter, other than the docs saying it was an integer. In testing, it appears to identify the event type and modifier keys. For example on my Mac, while moving the mouse, <tt class="docutils literal">flag</tt> is 0. Holding down the Control key while moving the mouse, it was 8. Holding down Shift and moving was 16. Since this may vary by platform, test before using this parameter.</p>
<p>The last param, <tt class="docutils literal">image</tt>, corresponds to whatever third parameter we passed in the <tt class="docutils literal">cv2.setMouseCallback()</tt> call. In our case, our call looks like <tt class="docutils literal"><span class="pre">cv2.setMouseCallback('CapturedImage',</span> click_and_crop, image)</tt> where we're passing the captured image in that parameter.</p>
<p>Next, we're going to handle three different mouse events associated with cropping an image. First, the user will click the mouse down at the top-left corner. Then, they'll drag down to the bottom right. And third, they'll release the mouse button. I'll cover these three separately. As you examine this code, remember, this function will be called repeatedly, every time there's a mouse event (such as moving the mouse over the image).</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>47
48
49
50
51</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="n">cv2</span><span class="o">.</span><span class="n">EVENT_LBUTTONDOWN</span><span class="p">:</span>
        <span class="c1"># user has clicked the mouse&#39;s left button</span>
        <span class="n">drawing</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1"># save those starting coordinates</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)]</span>
</pre></div>
</td></tr></table><p>When the user clicks the button down, we'll set our global <tt class="docutils literal">drawing</tt> variable to True. We'll use this for tracking state in the next sections. Then, we store the x/y coordinates of the mouse down event in our global <tt class="docutils literal">coords</tt> list.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>52
53
54
55
56
57
58
59</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="n">cv2</span><span class="o">.</span><span class="n">EVENT_MOUSEMOVE</span><span class="p">:</span>
        <span class="c1"># user is moving the mouse within the window</span>
        <span class="k">if</span> <span class="n">drawing</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># if we&#39;re in drawing mode, we&#39;ll draw a green rectangle</span>
            <span class="c1"># from the starting x,y coords to our current coords</span>
            <span class="n">clone</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;CapturedImage&#39;</span><span class="p">,</span> <span class="n">clone</span><span class="p">)</span>
</pre></div>
</td></tr></table><p>The user will move their mouse all over the image, even when they're not trying to crop it. We want this section of the code to run only if they've clicked down the mouse button. For that reason, we check the <tt class="docutils literal">drawing</tt> variable set in the mouse down portion of the function. When that's true, we'll create a clone of our original image. Next, we'll draw a rectangle on the clone with the top-left corner at <tt class="docutils literal">coords[0]</tt> (where the user clicked the mouse button down) and the current x/y coordinates. We'll draw a green outline (remember, OpenCV specifies the colors in blue-green-red order) with a width of 2. Finally, we show that image in our CapturedImage window.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="n">cv2</span><span class="o">.</span><span class="n">EVENT_LBUTTONUP</span><span class="p">:</span>
        <span class="c1"># user has released the mouse button, leave drawing mode</span>
        <span class="c1"># and crop the photo</span>
        <span class="n">drawing</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># save our ending coordinates</span>
        <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># calculate the four corners of our region of interest</span>
            <span class="n">ty</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">bx</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># crop the image using array slicing</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">ty</span><span class="p">:</span><span class="n">by</span><span class="p">,</span> <span class="n">tx</span><span class="p">:</span><span class="n">bx</span><span class="p">]</span>
            <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">roi</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># make sure roi has height/width to prevent imshow error</span>
                <span class="c1"># and show the cropped image in a new window</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">WINDOW_NORMAL</span><span class="p">)</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span> <span class="n">roi</span><span class="p">)</span>
</pre></div>
</td></tr></table><p>Finally, we handle the case when the user releases the mouse button. This is the bottom-right corner of the cropping rectangle. We set <tt class="docutils literal">drawing</tt> back to False so we stop processing mouse-move events. We append the new x/y coordinates to our global list. Assuming something didn't go wrong, that list will have two members.</p>
<p>On line 70, we crop the image. OpenCV images are represented as Numpy arrays of pixel values. We're using array slicing, in perhaps a non-inuitive way. Let's step back to line 68, where we grab the y values from the top-left and bottom-right corners (so <tt class="docutils literal">ty</tt> and <tt class="docutils literal">by</tt>), and then the x values from the two corners (<tt class="docutils literal">tx</tt> and <tt class="docutils literal">bx</tt>) out of our global <tt class="docutils literal">coords</tt> list.</p>
<p>We're ready to crop the image. OpenCV images are represented as Numpy arrays of pixel values. Since the image is just an array, we can use array slicing to select a portion of it -- in other words, to crop it. On line 68, we grab the y values from the top-left and bottom-right corners (so <tt class="docutils literal">ty</tt> and <tt class="docutils literal">by</tt>), and then the x values from the two corners (<tt class="docutils literal">tx</tt> and <tt class="docutils literal">bx</tt>) out of our global <tt class="docutils literal">coords</tt> list. Then on line 70, we crop by slicing the <tt class="docutils literal">image</tt> array to those ty/by, tx/bx values and storing the &quot;region of interest&quot; in the <tt class="docutils literal">roi</tt> variable.</p>
<p>If the user were to select a very small slice, such that either the width or height were treated as zero, the <tt class="docutils literal">imshow()</tt> function would throw an error. To avoid that, we'll calcualte the height and width of the cropped image by grabbing the first two members of the roi's shape. We do our zero-test and then show the <tt class="docutils literal">roi</tt> image in a new OpenCV window.</p>
<p>And that's it! If you haven't so far, try it out.</p>
<div class="highlight"><pre><span></span>python3 crop_image.py
</pre></div>
<p>Click, drag, and release on the &quot;CapturedImage&quot; window and you'll get a new window with the cropped portion of your original. It may show up behind other windows you have open. (That's an annoying OpenCV bug on some platforms.)</p>
<div class="section" id="the-whole-shebang">
<h2>The whole shebang</h2>
<p>Finally, let's close by seeing the entire script. Hopefully you've typed in the code as we went and didn't just copy &amp; paste it. But this here will let you check your work against my original.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">cv2</span>

<span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">drawing</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># construct the argument parser and parse the arguments</span>
    <span class="n">ap</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">ap</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="s2">&quot;--image&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to the image&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">ap</span><span class="o">.</span><span class="n">parse_args</span><span class="p">())</span>
    <span class="n">image_source</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="c1"># now get our image from either the file or built-in webcam</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">get_image</span><span class="p">(</span><span class="n">image_source</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># show the captured image in a window</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s1">&#39;CapturedImage&#39;</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">WINDOW_NORMAL</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;CapturedImage&#39;</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
        <span class="c1"># specify the callback function to be called when the user</span>
        <span class="c1"># clicks/drags in the &#39;CapturedImage&#39; window</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">setMouseCallback</span><span class="p">(</span><span class="s1">&#39;CapturedImage&#39;</span><span class="p">,</span> <span class="n">click_and_crop</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># wait for Esc or q key and then exit</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">27</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Image cropped at coordinates: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">coords</span><span class="p">))</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
                <span class="k">break</span>

<span class="k">def</span> <span class="nf">get_image</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="c1"># open the camera, grab a frame, and release the camera</span>
    <span class="n">cam</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">image_captured</span><span class="p">,</span> <span class="n">image</span> <span class="o">=</span> <span class="n">cam</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">cam</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">image_captured</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">image</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">click_and_crop</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Callback function, called by OpenCV when the user interacts</span>
<span class="sd">    with the window using the mouse. This function will be called</span>
<span class="sd">    repeatedly as the user interacts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get access to a couple of global variables we&#39;ll need</span>
    <span class="k">global</span> <span class="n">coords</span><span class="p">,</span> <span class="n">drawing</span>
    <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="n">cv2</span><span class="o">.</span><span class="n">EVENT_LBUTTONDOWN</span><span class="p">:</span>
        <span class="c1"># user has clicked the mouse&#39;s left button</span>
        <span class="n">drawing</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c1"># save those starting coordinates</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="n">cv2</span><span class="o">.</span><span class="n">EVENT_MOUSEMOVE</span><span class="p">:</span>
        <span class="c1"># user is moving the mouse within the window</span>
        <span class="k">if</span> <span class="n">drawing</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1"># if we&#39;re in drawing mode, we&#39;ll draw a green rectangle</span>
            <span class="c1"># from the starting x,y coords to our current coords</span>
            <span class="n">clone</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">clone</span><span class="p">,</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;CapturedImage&#39;</span><span class="p">,</span> <span class="n">clone</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="n">cv2</span><span class="o">.</span><span class="n">EVENT_LBUTTONUP</span><span class="p">:</span>
        <span class="c1"># user has released the mouse button, leave drawing mode</span>
        <span class="c1"># and crop the photo</span>
        <span class="n">drawing</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c1"># save our ending coordinates</span>
        <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># calculate the four corners of our region of interest</span>
            <span class="n">ty</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">bx</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># crop the image using array slicing</span>
            <span class="n">roi</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">ty</span><span class="p">:</span><span class="n">by</span><span class="p">,</span> <span class="n">tx</span><span class="p">:</span><span class="n">bx</span><span class="p">]</span>
            <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">roi</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># make sure roi has height/width to prevent imshow error</span>
                <span class="c1"># and show the cropped image in a new window</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">WINDOW_NORMAL</span><span class="p">)</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span> <span class="n">roi</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</td></tr></table><p>In this article, you saw how to detect and react to mouse actions, such as clicking and moving. Then, as an example of what to do with that sort of functionality, I showed you how to crop an image to the dimensions selected. In a future article, I will show you how to extract information from that region of interest, such as the predominant color.</p>
</div>

  </div>
  <div class="tag-cloud">
    <p>
      <a href="../tag/opencv.html">opencv</a>
    </p>
  </div>




</article>

    <footer>
<p>
  &copy; Tim Poulsen 2018 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>





<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Tim Poulsen ",
  "url" : "..",
  "image": "/images/tim_poulsen.jpg",
  "description": "Tim Poulsen's blog of software, hardware, and life"
}
</script>
</body>
</html>